@page "/visualizarofertavehicle/{offerId:int?}"
@inject NavigationManager Navegador
@inject offerListUseCase offerListUseCase
@inject vehicleListUseCase vehicleListUseCase
@inject userListUseCase userListUseCase
@inject listPostUseCase listPostUseCase
@inject modifyOfferUseCase modifyOfferUseCase
@inject modifyPostUseCase modifyPostUseCase
@inject addUnresolvedExchangeUseCase addUnresolvedExchangeUseCase
@inject deleteOfferUseCase deleteOfferUseCase
@inject listTransportUseCase listTransportUseCase
@inject userListUseCase userListUseCase

<DialogoConfirmacion @ref="dialogo" OnConfirmado="resolver"/>

<div>
    <h3> Te han ofrecido un @offeredVehicle.type de marca @offeredVehicle.model </h3>
	<h6> (Imagenes) </h6>
	<h6> Ofrecido por @userOffering.userName </h6>
    <h6> @offeredVehicle.description </h6>
	<h6> Patente @offeredVehicle.plate </h6>
    <h6> @offeredVehicle.kms kilometros </h6>
	@if (offeredVehicle.type != "Ciclomotor" ){
		<h6> @offeredVehicle.doors puertas </h6>
	}
</div>
<div>
	<button class="btn btn-primary" @onclick="confirmarAceptarOferta" data-bs-dismiss="modal">Aceptar oferta</button>
    <button class="btn btn-danger" @onclick="confirmarRechazarOferta" data-bs-dismiss="modal">Rechazar oferta</button>
</div>

<Emails @ref=emails/>

@code {

	[Parameter] public int? offerId {get; set;}

	Offer offer;

	Vehicle offeredVehicle;

	User userOffering;

	DialogoConfirmacion dialogo = null!;
	Emails emails = null!;

	bool accion = false;

	protected override async Task OnAfterRenderAsync(bool firstRender) {

		offer = offerListUseCase.Execute().Where(O => O.Id == offerId).SingleOrDefault();

		offeredVehicle = vehicleListUseCase.Execute().Where(T => T.Id == offer.transporteOfertadoId).SingleOrDefault();

		userOffering = userListUseCase.Execute().Where(U => U.Id == offeredVehicle.UserId).SingleOrDefault();

		StateHasChanged();

	}

	public void confirmarAceptarOferta () {
		accion = true;
		dialogo.Mostrar("¿Seguro que deseas aceptar la oferta?");
	}

	public void confirmarRechazarOferta () {
		accion = false;
		dialogo.Mostrar("¿Seguro que deseas rechazar la oferta?");
	}

	private void pausePost (int transportId) {
		Post post = listPostUseCase.Execute().Where(P => P.TransportId == transportId).SingleOrDefault();
		if (post != null) {
			post.paused = true;
			modifyPostUseCase.Execute(post);
		}
	}

	private void borrarOfertas (int transportId) {
		List<int> offers = offerListUseCase.Execute().Where(O => O.transporteOfertadoId == transportId && O.state == "active").ToList().Select(O => O.Id).ToList();
		foreach (int id in offers) {
			deleteOfferUseCase.Execute(id);
		}
	}

	public async void aceptarOferta () {
		
		pausePost(offer.transporteOfertadoId);
		pausePost(offer.transportePosteadoId);

		offer.state = "accepted";
		modifyOfferUseCase.Execute(offer);

		UnresolvedExchange unresolvedExchange = new UnresolvedExchange(offer.transportePosteadoId, offer.transporteOfertadoId);
		addUnresolvedExchangeUseCase.Execute(unresolvedExchange);

		borrarOfertas(offer.transporteOfertadoId);
		borrarOfertas(offer.transportePosteadoId);

		// Mail para avisar al ofertante
		User ofertante = getUser(offer.transporteOfertadoId);
		string titulo = getTitle(offer.transportePosteadoId);

		await emails.SendEmail(
			"¡Oferta aceptada!", // Subject
			ofertante.mail, // Mail
			"¡Oferta aceptada!", // Titulo
			$@"
			<p style='line-height: 140%;color: #f4f4f4;margin-bottom: 0;'>¡Tu oferta a <b>{titulo}</b> ha sido aceptada!</p>
			<p style='line-height: 140%;color: #f4f4f4;margin-top: 0;'>Ya podés entrar a la página para concretar el horario de intercambio</p>
			" // Cuerpo
		);

		Navegador.NavigateTo("listarmisintercambios/", true);
	}

	public async void rechazarOferta () {
		offer.state = "rejected";
		modifyOfferUseCase.Execute(offer);

		// Mail para avisar al ofertante
		User ofertante = getUser(offer.transporteOfertadoId);
		string titulo = getTitle(offer.transportePosteadoId);

		await emails.SendEmail(
			"Oferta rechazada", // Subject
			ofertante.mail, // Mail
			"Oferta rechazada", // Titulo
			$@"
			<p style='line-height: 140%;color: #f4f4f4;margin-bottom: 0;'>Tu oferta a <b>{titulo}</b> ha sido rechazada</p>
			<p style='line-height: 140%;color: #f4f4f4;margin-top: 0;'>Podés entrar a la página para seguir buscando el transporte de tus sueños</p>
			" // Cuerpo
		);

		Navegador.NavigateTo("shippost/" + offer.transportePosteadoId, true);
	}

	//Si metemos dos dialogos confirmacion puede haber problemas
	public void resolver () {
		if (accion)
			aceptarOferta();
		else
			rechazarOferta();
	}

	public User getUser(int transportId) {
		Transport transport = listTransportUseCase.Execute().Find(trans => trans.Id == transportId);
		return userListUseCase.Execute().Find(user => user.Id == transport.UserId);
	}

	public string getTitle(int transportId) {
		Transport postedTransport = listTransportUseCase.Execute().Find(transport => transport.Id == transportId);
    Post post = listPostUseCase.Execute().Find(post => post.TransportId == postedTransport.Id);
		return post.Title;
	}

}