@inject listShipImagesUseCase listShipImagesUseCase
@inject modifyShipUseCase modifyShipUseCase
@inject ProtectedSessionStorage sessionStorage
@inject shipPostListUseCase shipPostListUseCase
@inject addShipPostUseCase addShipPostUseCase

@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@rendermode InteractiveServer

<DialogoError @ref="dialogoError"/>

<div class="modal fade" id="visualizarBarcoCargadoModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Tu barco cargado</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" 
        data-bs-toggle="modal" data-bs-target="#listarBarcosModal"></button>
      </div>
        <form>
          <div class="modal-body form-body">
            <div class="carousel-container">
              <div id="carousel" class="carousel slide">
                <div class="carousel-inner">
                  <div class="carousel-item active">
                    <img src="@string.Format("data:image/jpeg;base64,{0}", Convert.ToBase64String(images[i]))"
                    height="280px" width="100%" style="object-fit: cover;"/>
                  </div>
                </div>
                <button class="carousel-control-prev" type="button" @onclick=MoveLeft>
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" @onclick=MoveRight>
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Next</span>
                </button>
              </div>
            </div>
                
            <div>
              <label class="form-label">Modelo</label>
              <input type="text" class="form-control" @bind=barco.model required>
            </div>
            <div >
              <label class="form-label">Descripción</label>
              <input type="text" class="form-control" @bind=barco.description required>
            </div>
            <div>
              <label class="form-label">Eslora</label>
              <input type="number" min=0 class="form-control" @bind=barco.eslora required>
            </div>
             <div>
              <label class="form-label">Manga</label>
              <input type="number" min=0 class="form-control" @bind=barco.manga required>
            </div>
             <div>
              <label class="form-label">Calado</label>
              <input type="number" min=0 class="form-control" @bind=barco.calado required>
            </div>
            <div >
              <label class="form-label">Matrícula</label>
              <input type="text" class="form-control" @bind=barco.plate required>
            </div>
            <div>
              <label class="form-label">Tiene motor</label>
              <select @bind=tieneMotor class="form-select" required>
                  <option value="" style="display:none"></option>
                  <option value="si">Si</option>
                  <option value="no">No</option>
              </select>
            </div>
          </div>
        </form>
        <div class="modal-footer">
            @if(publicando){
              <br>
              <input class="form-control" placeholder="Título para su publicación" type="text" @bind=title required>
            }
            <button class="btn btn-primary" @onclick="()=>mofificarBarco()">Modificar</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" 
            data-bs-toggle="modal" data-bs-target="#listarBarcosModal">Cerrar</button>
            @if(!publicando && !publicado){
              <button class="btn btn-success" @onclick="()=>confirmarPublicar()">Publicar</button>
            }
            @if(publicando){
              <button class="btn btn-success" @onclick="()=>publicar()">Definir Publicación</button>
            }
        </div>
      </div>
    </div>
</div>


@code {
    int i = 0;
    int limit = 0;
    string tieneMotor;
    DialogoError dialogoError = null!;

    bool publicando = false;
    bool publicado;
    string title = "";

    Ship barco = new Ship();
    List<byte[]> images = new List<byte[]>();

    protected override void OnInitialized() {
      images.Add(new byte[0]);
    }

    public void Cargar(Ship barco) {
      this.barco = barco;
      publicado = shipPostListUseCase.Execute().Where(s => s.ShipId == barco.Id).Count() > 0;
      tieneMotor = barco.hasEngine ? "si" : "no";
      i = 0;

      GetImages();
      StateHasChanged();
    }

    public void confirmarPublicar(){
      publicando = true;
      StateHasChanged();
    }

    public void publicar(){
      if(string.IsNullOrEmpty(this.title)){
        dialogoError.Mostrar("Por favor ponga un título antes de publicar");
      }
      else{
          addShipPostUseCase.Execute(new ShipPost(barco.Id, this.title));
          publicando = false;
          publicado = true;
          StateHasChanged();
      }
    }
    private void GetImages() {
      images = new List<byte[]>();
      var shipImages = listShipImagesUseCase.Execute().Where(img => img.ShipId == barco.Id);

      foreach (var img in shipImages) {
        images.Add(img.Image);
      }

      limit = images.Count() - 1;
    }

    public void MoveRight() {
      if (i < limit) i++;
      else i = 0;

      StateHasChanged();
    }

    public void MoveLeft() {
      if (i > 0) i--;
      else i = limit;

      StateHasChanged();
    }

    [Parameter]
    public EventCallback OnModificado { get; set; }

    // Hay un error con las patentes que hay que revisar
    void mofificarBarco() {
      try {
        barco.hasEngine = tieneMotor == "si" ? true : false;

        modifyShipUseCase.Execute(barco);
        OnModificado.InvokeAsync();
      }
      catch (Exception ex) {
        if (ex.Message == "This plate is already in our database") {
          dialogoError.Mostrar("La patente ingresada ya se encuentra registrada.");
        }
      }
    }
}